# ============================================
# Nexus - Docker Compose Configuration
# Next.js Application with External Supabase VM
# ============================================

services:
  # ========================================
  # Nexus Next.js Application
  # ========================================
  # NOTE: Supabase is running on a dedicated VM
  # Get Supabase URL and keys from: ~/supabase-simple/.env on the VM
  nexus:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nexus-app
    environment:
      # Supabase Configuration (from dedicated VM)
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_KEY}

      # Database URL (direct connection to VM Supabase)
      DATABASE_URL: ${DATABASE_URL}

      # AI Provider API Keys
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      MINIMAX_API_KEY: ${MINIMAX_API_KEY}

      # Application Settings
      NODE_ENV: production
      NEXUS_SECRET_KEY: ${NEXUS_SECRET_KEY}
    ports:
      - "3011:3000"
    volumes:
      - nexus-uploads:/app/uploads
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ========================================
  # Redis (Optional - for caching/sessions)
  # ========================================
  redis:
    image: redis:7-alpine
    container_name: nexus-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    restart: unless-stopped

# ========================================
# Volumes
# ========================================
volumes:
  redis_data:
    driver: local
  nexus-uploads:
    driver: local
